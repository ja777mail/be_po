name: Run Postman Collection

on:
  workflow_dispatch: # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches:
      - main

jobs:
  run-collection:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Newman
      - name: Install Newman
        run: npm install -g newman

      # 4. –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤
      - name: Create reports directory
        run: mkdir -p reports

      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å CLI, JSON –∏ HTML –æ—Ç—á—ë—Ç–∞–º–∏
      - name: Run Postman Collection
        run: |
          echo "üöÄ Running Postman collection..."
          newman run TestAPICollection.json \
            -r cli,json,html \
            --reporter-json-export reports/newman-report.json \
            --reporter-html-export reports/newman-report.html

      # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á—ë—Ç–æ–≤
      - name: Check report files
        run: |
          echo "üìÅ Contents of reports directory:"
          ls -la reports
          test -f reports/newman-report.json || (echo "‚ùå JSON report missing" && exit 1)
          test -f reports/newman-report.html || (echo "‚ùå HTML report missing" && exit 1)

      # 7. –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ JSON-–æ—Ç—á—ë—Ç–∞
      - name: Extract test summary from JSON report
        run: |
          echo "üìä Newman test summary:"
          passed=$(jq '.run.stats.assertions.total - .run.stats.assertions.failed' reports/newman-report.json)
          failed=$(jq '.run.stats.assertions.failed' reports/newman-report.json)
          total=$(jq '.run.stats.assertions.total' reports/newman-report.json)

          echo "‚úÖ Passed: $passed"
          echo "‚ùå Failed: $failed"
          echo "üìã Total:  $total"

          if [ "$failed" -gt 0 ]; then
            echo "‚ùó Some tests failed"
            exit 1
          fi

      # 8. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á—ë—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload Newman Reports
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/
